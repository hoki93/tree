<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambil 3 Foto & Kirim ke Telegram</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 1rem; background: #f7f7f8; color: #111; }
    video, canvas { border-radius: 8px; box-shadow: 0 5px 18px rgba(10,10,10,0.08); }
    .controls { margin-top: 0.5rem; display:flex; gap:8px; align-items:center; }
    button { padding: 8px 12px; border-radius:8px; border: none; background: #2563eb; color: white; cursor:pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .thumbs { display:flex; gap:8px; margin-top:12px; }
    .thumbs canvas { width: 120px; height: 90px; object-fit: cover; }
    .status { margin-top: 12px; }
  </style>
</head>
<body>
  <h2>Ambil 3 Foto & Kirim otomatis ke Telegram</h2>
  <video id="video" autoplay playsinline width="480" height="360"></video>
  <div class="controls">
    <button id="startBtn">Mulai & Ambil 3 Foto</button>
    <div id="countBadge">0 / 3</div>
  </div>

  <div class="thumbs" id="thumbs"></div>
  <div class="status" id="status"></div>

<script>
(async () => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const thumbs = document.getElementById('thumbs');
  const status = document.getElementById('status');
  const countBadge = document.getElementById('countBadge');

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
  } catch (err) {
    status.innerText = 'Gagal akses kamera: ' + err.message;
    startBtn.disabled = true;
    return;
  }

  let captured = [];
  function updateCount() {
    countBadge.innerText = `${captured.length} / 3`;
  }

  function captureOnce() {
    const canvas = document.createElement('canvas');
    const w = video.videoWidth || 480;
    const h = video.videoHeight || 360;
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    // small preview
    const preview = document.createElement('canvas');
    preview.width = 320;
    preview.height = 240;
    preview.getContext('2d').drawImage(canvas, 0, 0, preview.width, preview.height);
    thumbs.appendChild(preview);

    return canvas;
  }

  async function sendToServer() {
    status.innerText = 'Mengirim ke server...';

    const form = new FormData();
    for (let i = 0; i < 3; i++) {
      const blob = await new Promise(resolve => captured[i].toBlob(resolve, 'image/jpeg', 0.85));
      form.append('photo' + (i+1), blob, `photo${i+1}.jpg`);
    }

    try {
      const resp = await fetch('/api/upload', { method: 'POST', body: form });
      const j = await resp.json();
      if (j.success) {
        status.innerText = 'Berhasil dikirim ke Telegram âœ…';
      } else {
        status.innerText = 'Gagal mengirim: ' + (j.message || JSON.stringify(j.detail || j.error || j));
      }
    } catch (err) {
      status.innerText = 'Error saat mengirim: ' + err.message;
    }
  }

  startBtn.addEventListener('click', async () => {
    if (!stream) return;
    startBtn.disabled = true;
    status.innerText = 'Mengambil 3 foto...';
    captured = [];
    thumbs.innerHTML = '';
    updateCount();

    for (let i = 0; i < 3; i++) {
      await new Promise(r => setTimeout(r, 800));
      const c = captureOnce();
      captured.push(c);
      updateCount();
    }

    status.innerText = 'Selesai ambil, langsung kirim...';
    await sendToServer();
    startBtn.disabled = false;
  });

})();
</script>
</body>
</html>
